---
title: "ユーザーの全期間追跡を低コストで実現する dbt モデル設計"
emoji: "📊"
type: "tech"
topics: ["dbt", "BigQuery"]
published: false
publication_name: "pivotmedia"
---

## 1. はじめに

[ビジネス映像メディア「PIVOT」](https://pivotmedia.co.jp/app) データエンジニアの uma-chan です。

今回は dbt でデータ分析促進の一助となった事例を紹介します。

## 2. 課題

ユーザーの流入元分析を実施する中で、以下のようなモデルを新規作成しようとしていました。

- 流入元別の継続率分析 (初回訪問から N 週間後に再訪問したかなど)
- ユーザーの初回訪問から現状までの変化の追跡
- 長期的な視点でのユーザー獲得品質の評価

初期実装ではあまり深く考えずに以下のように実装したことで Out of Memory (OOM) エラーとなりました。

- FIRST_VALUE/LAST_VALUE ウィンドウ関数で全期間データを走査
- 全ユーザーの全期間データをメモリに展開

## 3. 設計のポイント

:::message
このモデルは MIN/MAX 系の指標 (初回訪問、最終訪問など) に限定されます。既存データと新規データを比較するだけで正しい結果が得られる場合でなければ、incremental モデル化は運用シーンを考慮して慎重に検討する必要があります。
:::

必要以上に集計コストが増大することを避けるため、まず手始めに全期間を低コストで追跡する方法として「incremental に向いているモデル設計」を考えました。

- ユニークキーは複数経路で付与されるユーザーIDを極力横断的に統一したもの
- 初回訪問の情報として全期間の初回訪問を記録し続ける、すなわち初回以降更新しない
- 最終訪問の場合、常に最新に更新する

この設計により、初回訪問・最終訪問イベントに紐づく情報（訪問時刻、流入元、プラットフォーム、流入経路など）や、プラットフォーム遷移パターン（Web→App転換など）も同じように追跡できます。

## 4. 成果

元々は初回訪問情報を得るには、全ユーザーの全期間データを走査する必要がありました。

変更後は incremental (差分更新) 処理を実行すれば、全期間の全員の初回訪問情報が得られます。処理データ量を大幅に削減できました。

実現できたことは以下の通りです。

- 本来は膨大なデータを集計しないと得られない一部のクエリ結果が、低コストで得られる
- 更新コストが低い (1日に複数回の更新処理実行でも全く問題ない)
- データ量が増えても、処理時間の増加量を抑えられる
- 下流データモデルは JOIN するだけで全期間の情報が得られる

## 5. 効果

事前集約モデル (全期間処理、400日分) の結果です。

- 行数は約190万行
- 処理データ量は 24.6 GiB
- 実行時間は約6分47秒
- 1ユーザー1レコードを保証

下流モデル (全期間処理、180日分) の結果です。

- 行数は約98万行
- 処理データ量は 27.7 GiB
- 実行時間は約1分20秒
- OOM 発生なし

incremental 実行時の結果です。

- 処理データ量は約 303 MiB (全期間処理の 1/90 以下)
- 初回訪問情報が正しく保持されることを確認
- レコードの重複なし

## 6. おわりに

初回訪問と最終訪問という特定の指標の全期間追跡を実現するために、「incremental に向いているモデル設計」という基本を押さえることにしました。

得られた成果を以下に示します。

- OOM 解消 (当初のきっかけ)
- 低コストでの運用 (副次的効果)
- ユーザーのユニークリストとして便利に使える (最大の価値)

ただし、このアプローチは既存データと新規データを比較するだけで正しい結果が得られる指標 (MIN/MAX 系) に限定されます。

学んだことを以下に示します。

- unique_key に「incremental 実行のたびに変わる値」を含めてはいけない
- incremental 実行時のロジックを明確に設計する

どんな指標なら incremental で追えるかについて説明します。

incremental で追える指標を以下に示します。

- 初回訪問では既存データと比較して古い方を保持
- 最終訪問では常に最新に更新
- MIN/MAX 系の指標では既存と新規を比較して適切な方を選択

incremental では難しい指標を以下に示します。

- 全期間の合計 (SUM) では毎回全期間を走査する必要がある
- 複雑な集計 (平均、中央値など) では元データが必要
- UNBOUNDED なウィンドウ関数では全期間データをメモリ展開

判断基準として「既存データと新規データを比較するだけで、正しい結果が得られるか」を考えると、どの指標を事前集約モデルに入れるべきか判断できます。

基本的なことですが、見落としがちです。この経験から、incremental モデルを設計する際は「incremental 実行時に何が起こるか」「この指標は incremental で追えるか」を常に意識するようになりました。

BigQuery の挙動と dbt の incremental モデルへの習熟度がまだまだなので引き続き学びを深めたいです。
