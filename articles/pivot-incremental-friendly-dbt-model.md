---
title: "データ分析を促進する dbt モデル設計 ― 全期間追跡の低コスト化"
emoji: "📊"
type: "idea"
topics: ["dbt", "dataengineering", "データ分析"]
published: false
publication_name: "pivotmedia"
---

## 1. はじめに

[ビジネス映像メディア「PIVOT」](https://pivotmedia.co.jp/app) データエンジニアの uma-chan です。

データエンジニアの役割は、データ利用を促進できるような基盤を作ることだと思っています。

今回はそれを念頭に置きつつ全期間のユーザー行動を低コストで追跡できる dbt データモデルを設計した話を紹介します。このモデルを足がかりに、様々な時間軸での分析を促進できればと考えています。

## 2. 課題

ユーザーの流入元分析を実施する中で、以下のようなデータモデルを新規作成しようとしていました。

- 流入元別の継続率分析（初回訪問から N 週間後に再訪問したかなど）
- ユーザーの初回訪問から現状までの変化の追跡
- 長期的な視点でのユーザー獲得品質の評価

初期実装ではあまり深く考えずに以下のように実装したことで Out of Memory (OOM) エラーとなりました。

- FIRST_VALUE/LAST_VALUE ウィンドウ関数で全期間データを走査
- 全ユーザーの全期間データをメモリに展開

## 3. 設計のポイント

:::message
既存データと新規データを比較するだけで正しい結果が得られる指標でない場合は incremental（差分更新）データモデル化は運用シーンを考慮して慎重に検討する必要があります。
:::

必要以上に集計コストが増大することを避けるため、まず手始めに全期間を低コストで追跡する方法として「incremental（差分更新）に向いているデータモデル設計」を考えました。

- ユニークキーは複数経路で付与されるユーザーIDを極力横断的に統一したもの
    - ここが実はデータマートとして存在していなかったので隠れた成果
- 初回訪問の情報として全期間の初回訪問を記録し続ける、すなわち初回以降更新しない
- 最終訪問の場合、常に最新に更新する

同じ要領で以下もカラムとして追加できます。

- 初回訪問・最終訪問イベントに紐づく情報
    - 訪問時刻、流入元、プラットフォーム、流入経路など
- それに伴う派生指標
    - 例：流入経路分類、プラットフォーム遷移パターン、経過日数など

## 4. 成果

### 4.1. 技術的な成果

- 処理データ量は全期間処理の約 1/90 以下に削減
- OOM 発生なし
- 更新コストが低い（1日に複数回の更新処理実行でも全く問題ない）

### 4.2. データ分析への貢献

- 下流データモデルは JOIN するだけで全期間の情報が得られる
- 本来は膨大なデータを集計しないと得られないクエリ結果が、低コストで得られる
- プラットフォーム遷移パターンや流入経路分類など、MIN/MAX で算出できる派生指標も低コストで提供できる
- 分析者が気軽に長期間のユーザー行動を分析できる環境が整った

## 5. おわりに

初回訪問と最終訪問という特定の指標を中心に据えて全期間追跡を実現するために、「incremental に向いているデータモデル設計」という基本を押さえることにしました。

OOM 解消だけでなく、低コストでの運用や擬似的なユーザーのユニークリストという副次的な成果も得られました。

繰り返しますがこのアプローチは既存データと新規データを比較するだけで正しい結果が得られる指標に限定して考えたほうがよい話にはなります。

今回のデータモデルは、長期間の分析に目を向けるための第一歩として導入しました。このデータモデルを基礎として、様々な時間軸でのユーザー行動分析を円滑に進められる一助になれればと思います。
